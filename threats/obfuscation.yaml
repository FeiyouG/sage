# Obfuscation threat patterns for Sage
# Author: Gen Digital Inc.
# License: DRL-1.1 (see threats/LICENSE)

# --- Base64 decode piped to shell ---
- id: "CLT-OBFUS-001"
  category: tool
  severity: critical
  confidence: 0.95
  action: block
  pattern: "base64\\s+(-d|--decode)\\s*\\|\\s*(bash|sh|zsh|ksh|dash)"
  match_on: command
  title: "Base64 decode piped to shell execution"
  expires_at: null
  revoked: false

# --- Hex escape sequences in printf ---
- id: "CLT-OBFUS-002"
  category: tool
  severity: medium
  confidence: 0.70
  action: require_approval
  pattern: "printf\\s+[\"']\\\\x[0-9a-fA-F]{2}(\\\\x[0-9a-fA-F]{2}){3,}"
  match_on: command
  title: "Hex escape sequences in printf (potential obfuscation)"
  expires_at: null
  revoked: false

# --- Reversed string piped to shell ---
- id: "CLT-OBFUS-003"
  category: tool
  severity: critical
  confidence: 0.90
  action: block
  pattern: "\\|\\s*rev\\s*\\|\\s*(bash|sh|zsh|ksh|dash)"
  match_on: command
  title: "Reversed string piped to shell execution"
  expires_at: null
  revoked: false

# --- Eval with decode ---
- id: "CLT-OBFUS-004"
  category: tool
  severity: critical
  confidence: 0.90
  action: block
  pattern: "\\beval\\s+.*\\$\\(\\s*base64|python[3]?\\s+-c\\s+[\"'].*exec\\(.*decode"
  match_on: [command, content]
  title: "Eval with decode (obfuscated code execution)"
  expires_at: null
  revoked: false

# --- Shell metacharacter escaping ---
- id: "CLT-OBFUS-005"
  category: tool
  severity: high
  confidence: 0.85
  action: block
  pattern: "\\|\\s*[\\\\'\"]+(bash|sh|zsh|ksh|dash)[\\\\'\"]*(\\s|$)"
  match_on: command
  title: "Shell metacharacter escaping to hide pipe target"
  expires_at: null
  revoked: false

# --- Alias/function redefinition ---
- id: "CLT-OBFUS-006"
  category: tool
  severity: high
  confidence: 0.80
  action: require_approval
  pattern: "\\balias\\s+(bash|sh|zsh|curl|wget|nc|netcat|python|ruby|perl|node)="
  match_on: command
  title: "Alias redefinition of security-relevant command"
  expires_at: null
  revoked: false

- id: "CLT-OBFUS-007"
  category: tool
  severity: high
  confidence: 0.80
  action: require_approval
  pattern: "\\b(function\\s+)?(bash|sh|curl|wget|nc|python|ruby|perl|node)\\s*\\(\\s*\\)"
  match_on: command
  title: "Function redefinition of security-relevant command"
  expires_at: null
  revoked: false
