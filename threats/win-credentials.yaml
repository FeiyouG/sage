# Windows credential exposure threat patterns for Sage
# Author: Gen Digital Inc.
# License: DRL-1.1 (see threats/LICENSE)

# cmdkey stored credentials
- id: "CLT-WIN-CRED-001"
  category: secrets
  severity: high
  confidence: 0.85
  action: require_approval
  pattern: "\\b[Cc]mdkey\\s+/add:"
  match_on: command
  title: "Stored credential creation via cmdkey"
  expires_at: null
  revoked: false

# ConvertTo-SecureString with plaintext
- id: "CLT-WIN-CRED-002"
  category: secrets
  severity: high
  confidence: 0.85
  action: require_approval
  pattern: "[Cc]onvert[Tt]o-[Ss]ecure[Ss]tring.*-[Aa]s[Pp]lain[Tt]ext"
  match_on: command
  title: "ConvertTo-SecureString with plaintext password"
  expires_at: null
  revoked: false

# Reading credential files on Windows (type, more, Get-Content)
- id: "CLT-WIN-CRED-003"
  category: secrets
  severity: high
  confidence: 0.80
  action: require_approval
  pattern: "\\b(type|more|[Gg]et-[Cc]ontent)\\b.*\\.(env|credentials|pgpass|netrc)"
  match_on: command
  title: "Reading credential file via type/more/Get-Content"
  expires_at: null
  revoked: false

# [Environment]::SetEnvironmentVariable with credential keyword
- id: "CLT-WIN-CRED-004"
  category: secrets
  severity: high
  confidence: 0.80
  action: require_approval
  pattern: "\\[Environment\\]::SetEnvironmentVariable.*([Pp]assword|[Ss]ecret|[Tt]oken|[Kk]ey)"
  match_on: command
  title: "Setting credential environment variable via .NET"
  expires_at: null
  revoked: false

# $env: credential assignment
- id: "CLT-WIN-CRED-005"
  category: secrets
  severity: high
  confidence: 0.80
  action: require_approval
  pattern: "\\$env:.*([Pp]assword|[Ss]ecret|[Tt]oken|[Aa]pi_?[Kk]ey)\\s*="
  match_on: command
  title: "PowerShell $env: credential variable assignment"
  expires_at: null
  revoked: false

# Mimikatz / sekurlsa
- id: "CLT-WIN-CRED-006"
  category: secrets
  severity: critical
  confidence: 0.95
  action: block
  pattern: "[Mm]imikatz|[Ss]ekurlsa::"
  match_on: command
  title: "Mimikatz credential dumping tool"
  expires_at: null
  revoked: false

# Registry hive export for credential theft
- id: "CLT-WIN-CRED-007"
  category: secrets
  severity: critical
  confidence: 0.95
  action: block
  pattern: "\\breg\\s+save\\b.*\\bHKLM\\\\(SAM|SYSTEM|SECURITY)\\b"
  match_on: command
  title: "Registry hive export for credential theft (reg save HKLM\\SAM/SYSTEM)"
  expires_at: null
  revoked: false

# LSASS credential dumping
- id: "CLT-WIN-CRED-008"
  category: secrets
  severity: critical
  confidence: 0.95
  action: block
  pattern: "\\b(procdump|procdump64)\\b.*\\blsass\\b|\\brundll32\\b.*\\bcomsvcs(\\.dll)?\\b.*\\bMiniDump\\b"
  match_on: command
  title: "LSASS credential dumping (procdump/comsvcs.dll MiniDump)"
  expires_at: null
  revoked: false

# WLAN password extraction (ex CLT-TECH-034)
- id: "CLT-WIN-CRED-009"
  category: secrets
  severity: high
  confidence: 0.80
  action: require_approval
  pattern: "netsh.*wlan.*show.*profiles.*key=clear"
  case_insensitive: true
  match_on: command
  title: "WLAN password extraction via netsh"
  expires_at: null
  revoked: false
